# 导入、导出与批量操作

为了提升后台管理效率，本项目内置了强大的数据批量处理能力，以“用户管理”模块为例，涵盖了模板下载、数据导入、批量删除和异步导出等常用功能。

## 1. 模板下载

在进行数据导入前，通常需要为用户提供一个符合格式要求的模板文件。

*   **API 接口**: `GET /api/users/template`
*   **查询参数**:
    *   `format` (可选): `csv` 或 `xlsx`，默认为 `xlsx`。
*   **功能说明**:
    *   该接口会动态生成包含预设表头（如 `账号名`, `密码`, `角色(逗号分隔)`）的模板文件。
    *   前端通过简单的 `window.open` 或 a 标签下载即可。
*   **适用场景**:
    *   适用于模板字段较少、格式简单的场景。对于字段复杂、包含下拉选项或校验规则的模板，建议在项目中存放静态的 Excel 文件，由前端直接下载。

## 2. 数据导入

数据导入功能允许用户通过上传 CSV 或 Excel 文件来批量创建或更新数据。

*   **API 接口**: `POST /api/users/import`
*   **查询参数**:
    *   `mode` (可选): `insert` 或 `upsert`，默认为 `insert`。
*   **请求体**: `multipart/form-data`，包含一个名为 `file` 的文件。
*   **核心校验逻辑** (在 `UserService` 中实现):
    1.  **文件解析**: 使用 `xlsx` 库解析上传的文件，获取所有行数据。
    2.  **逐行校验**:
        *   **必填校验**: 检查 `账号名`, `密码`, `角色` 字段是否为空。
        *   **格式校验**: 检查密码长度是否满足要求（例如，最小 6 位）。
        *   **业务规则校验**: 查询数据库，验证指定的角色名称是否真实存在。
    3.  **数据处理**:
        *   **`insert` 模式**: 如果账号名已存在，该行数据将被视为错误。
        *   **`upsert` 模式**: 如果账号名已存在，则更新该用户信息；如果不存在，则创建新用户。
*   **响应内容**:
    *   接口会返回一个包含处理结果的 JSON 对象，例如：
        ```json
        {
          "successCount": 98,
          "failureCount": 2,
          "errors": [
            { "row": 5, "message": "账号 'test' 已存在" },
            { "row": 20, "message": "角色 'invalid-role' 不存在" }
          ]
        }
        ```
    *   前端可以根据这个响应，向用户清晰地展示导入结果。

## 3. 批量删除

批量删除允许用户在表格中勾选多项数据后一次性删除。

*   **API 接口**: `POST /api/users/batch-delete`
*   **请求体**:
    ```json
    {
      "ids": [1, 2, 5, 10]
    }
    ```
*   **前端实现**:
    *   Ant Design 的 `ProTable` 提供了 `rowSelection` 功能，可以方便地获取用户勾选行的 `id` 列表。
    *   前端将 `id` 数组作为请求体，发送给后端接口。
*   **后端实现**:
    *   `UserService` 接收 `ids` 数组。
    *   使用 `Prisma` 的 `deleteMany` 方法，在 `where` 条件中使用 `id: { in: ids }` 来执行批量删除，效率很高。

## 4. 异步导出

为了避免大数据量导出阻塞请求，所有导出功能都设计为异步任务。

*   **用户体验**:
    1.  用户在列表页面点击“导出”按钮，并可选择筛选条件。
    2.  系统立即提示“导出任务已创建”，用户无需等待。
    3.  用户可以导航到“系统管理 -> 导出任务”页面，查看任务的实时状态（排队中、处理中、已完成、失败）。
    4.  任务完成后，用户在该页面可以直接点击“下载”按钮获取文件。
*   **API 接口**: `POST /api/export-tasks`
*   **技术实现**:
    *   该功能基于 **BullMQ** 任务队列实现，具有高可靠性和可扩展性。
    *   关于异步导出任务的详细技术架构、数据流和扩展方法，请参考 **[异步导出任务设计](./导出任务.md)**。

