# 登录设计

这套登录设计强调「可扩展 + 可审计 + 可控会话」，核心由验证码、防重放、两步登录与 Redis 会话管理组成。

## 1. 登录流程

1. 获取验证码：`GET /auth/captcha`
2. 提交账号密码 + 验证码：`POST /auth/login`
3. 若开启 2FA：返回临时 token（scope=2fa），进入第二步
4. 验证 OTP：`POST /auth/login/2fa`
5. 下发正式 access token

## 2. 验证码机制

- 使用 `svg-captcha` 生成
- 验证码存入 Redis（带过期时间）
- `CaptchaGuard` 校验并单次失效

## 3. Token 策略

- Token 存在 Redis，包含：
  - `userId` / `username`
  - `scope`（access/2fa）
  - `ver`（用户会话版本）
  - `issuedAt` / `lastRenewAt`
- `TokenAuthGuard` 校验 token & session version
- 支持滑动续期 + 最大会话寿命

## 4. 2FA 设计

- 使用 `otplib` 生成 `otpSecret`
- 通过 `qrcode` 输出绑定二维码
- `scope=2fa` 的临时 token 仅允许走 2FA 接口

## 5. 会话失效与强制下线

- 每个用户有 `ver`（版本号）
- 全量退出：`logoutAll` 会递增 `ver`，强制旧 token 失效
- 单次退出：删除当前 token

## 6. 设计亮点

- 验证码 + 2FA 在同一条身份链上
- Redis token 便于多端会话管理
- `scope` 分离阶段权限，避免 2FA 绕过

