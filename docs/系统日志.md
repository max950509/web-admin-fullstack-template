# 系统日志（ELK）

## 目标

- 输出结构化 JSON 日志，字段对齐 ECS/OTel，保证可聚合、可关联。
- 本地与生产均使用 Docker + ELK 采集，便于统一查询与可视化。
- 噪音控制尽量放在采集侧，不在应用里硬编码过多规则。

## 日志字段契约（ECS/OTel 对齐）

系统日志使用 nestjs-pino + @elastic/ecs-pino-format 输出结构化 JSON 到 stdout，字段口径固定如下：

- service.name / service.version / deployment.environment
- @timestamp
- log.level
- message
- http.request.method
- http.route (模板路由，不是 raw path)
- http.response.status_code
- event.duration (单位 ns)
- trace.id / span.id
- request.id
- client.ip / user_agent.original
- user.id / user.name (可选)

raw path 只允许进入 url.path，禁止作为聚合字段。

## http.route 获取规则

- 优先使用 req.baseUrl + req.route?.path (仅当 req.route 存在时有效)
- 兜底使用 Reflector 拼 controller path + handler path (保留 :id 等模板参数)
- 再兜底写 http.route = "unknown"
- 禁止降级为 raw path 或拼接 query

## event.duration 口径

使用高精度时间源计算差值，建议基于 process.hrtime.bigint() 得到 ns。

## 脱敏策略

必脱敏路径示例：

- req.headers.authorization
- req.headers.cookie
- req.body.password
- req.body.token
- req.body.otpSecret
- req.body.refreshToken

访问日志不记录完整 body，必要时只记录长度/白名单字段，避免成本失控。

## /operation-logs 的处理原则

- 默认不 drop，改为分流到 audit 数据集 (event.dataset=audit 或 log.logger=audit)。
- 若确认纯噪音才 drop，并在采集配置里标注理由。
- 审计日志与访问日志边界明确，避免同一事件重复或互相覆盖。

## 采集方案（Docker + ELK）

目录：`deploy/elk`

1) 启动 ELK

```bash
docker compose -f deploy/elk/docker-compose.yml up -d
```

2) 采集侧使用 Vector (docker_logs)

- Input: docker_logs (Docker Engine API)
- Parser: 解析应用的 Pino JSON
- Filter: drop OPTIONS，审计类日志分流到 audit dataset
- Output: Elasticsearch data stream (logs-system-default / logs-audit-default)

3) Kibana 中创建 Data View

- Data View：`logs-*`

## Docker Desktop 推荐做法

macOS + Docker Desktop 推荐用 Vector 的 docker_logs 直接读取 Docker Engine API，无需 logging driver。

完整示例见 `deploy/docker-compose.yml`。

## Metrics 约束（Prometheus）

- labels 只允许 method/route/status_class
- 禁止 labels：path/userId/requestId/username/ip
- 建议 buckets (秒)：0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10

## Traces 采样原则

- Head sampling: SDK 侧 1%~5%
- Tail sampling: Collector Gateway 侧，仅保留错误/慢请求
- 默认慢请求阈值 > 1s，可通过环境变量调整

## Logs 阶段验收

- Kibana 能按 service.name、deployment.environment、http.route、request.id 搜索
- 任意请求日志包含 http.route/event.duration/client.ip/user_agent.original
- /operation-logs 能落到 audit 数据集且字段包含 audit 标记

## 本地开发

- 后端以 Docker 方式运行时，Vector 会通过 Docker API 采集容器日志。
- 后端直接本地运行时，日志仍可在终端查看；需要采集时建议也用容器方式运行后端。
