# 前端架构设计

本项目前端部分是一个基于 **React 18 + Vite** 构建的现代化单页应用 (SPA)，深度整合了 **Ant Design 5.x** 及其 ProComponents，并在此之上构建了一套高效、可维护的“Schema 驱动”开发范式。

## 1. 设计哲学

*   **配置化优于硬编码**: 尽可能通过数据结构（Schema）来描述 UI，而不是手写大量的 JSX。这使得代码更易于维护和复用。
*   **约定大于配置**: 我们定义了一套标准的组件和开发模式（如 `BaseProTable`），新页面的开发应遵循这些约定，以保证项目风格的统一和开发效率。
*   **关注点分离**: 明确划分 `路由`、`UI 组件`、`业务逻辑` 和 `数据请求` 的职责，使代码结构清晰。

## 2. 核心架构图

```
+-------------------+      +-------------------+      +-------------------+
|   React Router    |----->|       Pages       |<---->|    Components     |
| (路由 & 权限控制) |      |  (页面级组件)      |      | (可复用 UI 组件)   |
+-------------------+      +--------+----------+      +--------+----------+
                                     |                         |
                                     | (调用)                  | (调用)
                                     v                         v
+-------------------+      +-------------------+      +-------------------+
|      Services     |----->|  Utils (Request)  |<---->|       Hooks       |
| (按模块封装 API)   |      | (axios 封装)      |      | (如 usePermissions)|
+-------------------+      +-------------------+      +-------------------+
```

## 3. Schema 驱动的 CRUD

这是本前端架构的精髓所在，旨在用一套统一的 Schema 来同时驱动**表格（Table）**、**表单（Form）**和**详情（Description）**的渲染。

### 3.1. Columns Schema 定义

我们以“用户管理”为例，首先会定义一个基础的 `BASE_COLS`，它描述了用户这个资源的所有字段及其基本展示方式。

```typescript
// a/p/system/user/columns.tsx

// 基础定义
export const BASE_COLS: ProColumns<API.User>[] = [
  { title: 'ID', dataIndex: 'id', key: 'id' },
  { title: '用户名', dataIndex: 'username', key: 'username' },
  { title: '邮箱', dataIndex: 'email', key: 'email' },
  { title: '创建时间', dataIndex: 'createdAt', key: 'createdAt', valueType: 'dateTime' },
];

// 用于表单的 Schema
export const FORM_COLS: ProColumns<API.User>[] = patchSchema(
  BASE_COLS,
  {
    // 在表单中，ID 字段应被隐藏
    id: { hideInForm: true },
    // 创建时间也应被隐藏
    createdAt: { hideInForm: true },
    // 为 username 添加表单校验规则
    username: { formItemProps: { rules: [{ required: true }] } },
    // 新增一个密码字段，并设置其仅在表单中可见
    password: {
      title: '密码',
      dataIndex: 'password',
      key: 'password',
      valueType: 'password',
      hideInTable: true, // 在表格中隐藏
      hideInDescriptions: true, // 在详情中隐藏
      formItemProps: { rules: [{ required: true, min: 6 }] },
    },
  }
);
```

### 3.2. `patchSchema` 的作用

`patchSchema` 是一个工具函数，它接收一个基础 Schema 和一个“补丁”对象，然后根据 `dataIndex` 合并两者，生成一个新的 Schema。这使得我们可以方便地派生出不同场景下的 Schema，而无需重写大量重复定义。

### 3.3. `BaseProTable` 组件

`BaseProTable` 是对 Ant Design ProTable 的一层封装，它统一了分页逻辑、请求格式和默认行为。

```tsx
// a/p/system/user/index.tsx

const UserPage = () => {
  return (
    <BaseProTable
      columns={BASE_COLS} // 表格使用基础 Schema
      request={(params) => services.user.find(params)}
      toolBarRender={() => [
        <CreateUserModal columns={FORM_COLS} />, // 新增弹窗使用表单 Schema
      ]}
    />
  );
};
```

通过这种方式，我们实现了：
*   **高效复用**: 字段定义只需一份。
*   **易于维护**: 修改一个字段的 `title`，表格、表单、详情页会自动同步更新。
*   **代码简洁**: 页面组件的代码量大大减少，只需关注核心的业务逻辑。

## 4. 路由与多标签页

*   **路由定义**: 所有路由集中在 `src/router/routes.tsx` 中定义。我们通过 `handle` 字段为路由附加元数据：
    *   `handle.code`: 定义访问该路由所需的权限码。
    *   `handle.noKeepAlive`: 设置为 `true` 可以禁用该页面的缓存。
    *   `handle.fixed`: 设置为 `true` 使其成为一个不可关闭的固定标签页。
*   **动态路由生成**: 用户登录后，前端会根据后端返回的权限列表，过滤全量路由表，只注册用户有权访问的路由。
*   **页面缓存 (KeepAlive)**:
    *   我们使用 `react-activation` 提供的 `<KeepAlive>` 组件来包裹页面。
    *   `TabsContext` 负责管理标签页的 UI 状态（增、删、激活）。
    *   当关闭一个标签页时，会同步调用 `drop` 方法销毁对应的组件缓存，释放内存。
    *   详情请阅读 **[多标签页与状态保持](./docs/多标签与KeepAlive.md)**。

## 5. 统一请求层

我们对 `axios` 进行了封装，位于 `src/utils/request.ts`，实现了以下功能：

*   **自动注入 Token**: 在请求拦截器中，自动从本地存储获取 `access_token` 并添加到 `Authorization` 请求头中。
*   **响应统一处理**: 在响应拦截器中，对后端返回的数据结构进行统一处理，直接返回 `data` 部分。
*   **全局错误处理**: 统一处理 HTTP 错误（如 401, 403, 500），并给出全局错误提示。
*   **Token 失效处理**: 当收到 401 响应时，自动清空本地会话并跳转到登录页。

## 6. 代码组织结构

`src` 目录遵循了社区的最佳实践，按功能进行划分：

*   `assets/`: 存放静态资源，如图片、SVG。
*   `components/`: 存放可复用的 UI 组件，如 `BaseProTable`。
*   `contexts/`: 存放 React Context，如 `TabsContext`。
*   `hooks/`: 存放自定义 Hooks，如 `usePermissions`。
*   `pages/`: 存放页面级组件，按业务模块划分。
*   `router/`: 存放路由定义和逻辑。
*   `services/`: 存放 API 请求函数，按后端模块划分。
*   `types/`: 存放全局 TypeScript 类型定义。
*   `utils/`: 存放工具函数，如 `request.ts`。
