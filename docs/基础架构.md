# 基础架构

这套模板是一个「前后端分离 + 权限管理」的后台系统骨架，目标是能快速扩展新模块、统一数据与权限模型、并保证可维护性。

## 1. 技术栈概览

- 后端：NestJS + Prisma + PostgreSQL
- 缓存/会话：Redis（用于 token 与验证码）
- 前端：React 18 + Ant Design Pro Components
- 通用能力：操作日志、导出任务、部门/岗位、权限系统

## 2. 后端模块分层

后端模块按“业务域”拆分，每个模块包含 controller/service/dto：

- `auth`：登录、验证码、2FA、Token 签发
- `user`：账号管理（含角色绑定）
- `role` / `permission`：角色权限配置
- `department` / `position`：组织结构
- `operation-log`：操作日志
- `export-task`：导出任务队列

核心跨切能力：

- `TokenAuthGuard`：验证 token + session version
- `PermissionsGuard`：根据 `action/resource` 判权
- `OperationLogInterceptor`：记录用户操作 + 脱敏

## 3. 数据模型核心

权限模型三层：

- `User` ↔ `Role`：通过 `UserRole` 关联
- `Role` ↔ `Permission`：通过 `RolePermission` 关联
- `Permission` 结构化：`type`（menu/page/action）+ `parentId` + `sort`

组织结构：

- `Department`（支持树）
- `Position`（关联部门）

审计与任务：

- `OperationLog`：用户操作审计
- `ExportTask`：导出任务异步执行与下载

## 4. 前端组织方式

- `routes.tsx` 维护路由与权限 code（如 `read:account`）
- `BaseProTable` 封装分页 / 请求格式 / 表格默认配置
- `patchSchema` 将同一套 schema 派生为：
  - 列表 columns
  - 新增/编辑表单
  - 详情描述

## 5. 设计取向

- **约束强于约定**：权限体系 + 统一 schema 让功能扩展有固定入口
- **模块粒度清晰**：每个模块可独立 CRUD + 接入权限
- **扩展友好**：导出任务、日志等都是“可插拔模块”

