# 操作日志设计

操作日志是后台管理系统不可或缺的审计功能，它记录了用户在系统中执行的关键操作，为安全审计、问题追溯和行为分析提供了重要依据。

## 1. 设计目标

*   **全面审计**: 记录所有关键的写操作和部分重要的读操作。
*   **信息丰富**: 每条日志包含足够的信息，以便于追溯操作者、操作时间、操作内容和操作结果。
*   **数据安全**: 对敏感信息进行脱敏处理，防止敏感数据泄露。
*   **性能优化**: 通过降噪策略，避免记录不必要的日志，减少存储压力。

## 2. 核心实现：`OperationLogInterceptor`

操作日志的记录主要通过 NestJS 的 **`OperationLogInterceptor`** 实现。这是一个全局拦截器，它会在请求处理的不同阶段介入，自动捕获和记录操作信息。

### 工作原理

1.  **请求拦截**: 在 Controller 方法执行之前，拦截器会捕获请求的上下文。
2.  **信息提取**:
    *   从 `req.user` 中获取当前登录用户的 ID 和名称。
    *   从 `req` 中获取请求方法 (`method`)、路径 (`path`)、IP 地址 (`ip`) 和用户代理 (`userAgent`)。
    *   从 `req.body` 或 `req.query` 中获取请求的 `payload`。
3.  **脱敏处理**: 对捕获到的 `payload` 进行敏感信息脱敏。
4.  **操作元数据**: 通过自定义的 `@OperationLog` 装饰器，可以在 Controller 方法上声明本次操作的 `action` 和 `resource`，例如 `@OperationLog('create', 'user')`。拦截器会读取这些元数据。
5.  **响应拦截**: 在 Controller 方法执行完毕并返回响应后，拦截器会捕获响应的状态码 (`statusCode`)。
6.  **日志写入**: 将收集到的所有信息组装成 `OperationLog` 对象，并持久化到数据库中。

## 3. 记录内容 (`OperationLog` 实体)

`OperationLog` 实体记录了以下关键信息：

*   `id`: 日志唯一标识。
*   `action`: 操作类型（如 `create`, `update`, `delete`, `login`）。
*   `resource`: 操作资源（如 `user`, `role`, `permission`）。
*   `method`: HTTP 请求方法（`GET`, `POST`, `PUT`, `DELETE`）。
*   `path`: 请求路径。
*   `statusCode`: HTTP 响应状态码。
*   `ip`: 客户端 IP 地址。
*   `userAgent`: 客户端 User-Agent 字符串。
*   `payload`: 请求体或查询参数（已脱敏）。
*   `operatorId`: 操作用户 ID。
*   `operatorName`: 操作用户名称。
*   `createdAt`: 操作时间。

## 4. 脱敏策略

为了保护用户隐私和系统安全，操作日志会对请求 `payload` 中的敏感字段进行脱敏处理。

*   **内置敏感字段列表**: 系统维护一个敏感字段名称列表，例如：`password`, `token`, `authorization`, `captcha`, `otpSecret`, `refreshToken` 等。
*   **递归遍历与替换**: `OperationLogInterceptor` 会递归遍历请求的 `payload` 对象。如果遇到与敏感字段列表中的名称匹配的键，其对应的值将被替换为 `***`。
*   **深度脱敏**: 即使敏感字段嵌套在多层对象中，脱敏策略也能有效识别并处理。

## 5. 降噪策略

为了避免记录大量不必要的日志，我们实施了以下降噪策略：

*   **HTTP 方法过滤**: 默认情况下，`OPTIONS` 预检请求不会被记录，因为它们通常不包含业务操作。
*   **特定路径过滤**: 针对一些频繁访问但无审计价值的接口（例如，查询操作日志本身的接口 `/api/operation-logs`），可以配置为不记录日志。
*   **只记录关键操作**: 主要关注对数据有修改的 `POST`, `PUT`, `DELETE` 请求，以及部分重要的 `GET` 请求（如登录、敏感信息查询）。

## 6. 日志存储与查询

*   **存储**: 操作日志数据存储在 PostgreSQL 数据库的 `OperationLog` 表中。
*   **查询**: 前端提供了一个“操作日志”页面，允许管理员根据操作者、操作类型、资源、时间范围等条件进行筛选和查询，方便进行审计和问题排查。
*   **Dashboard 集成**: 重要的操作日志数据也可以集成到 Grafana 等 Dashboard 中，进行可视化展示和趋势分析。

