x-logging: &default-logging
  # Rotate stdout/stderr logs to avoid unlimited disk growth
  driver: json-file
  options:
    max-size: "50m"
    max-file: "5"

services:
  postgres:
    image: postgres:16
    logging: *default-logging
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: web_admin
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7
    logging: *default-logging
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  migrate:
    build:
      context: ..
      dockerfile: backend/nestjs/Dockerfile
      target: migrate
    logging: *default-logging
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/web_admin?schema=public
    depends_on:
      - postgres
    restart: "no"

  seed:
    build:
      context: ..
      dockerfile: backend/nestjs/Dockerfile
      target: seed
    logging: *default-logging
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/web_admin?schema=public
    depends_on:
      - postgres
      - migrate
    restart: "no"

  backend:
    build:
      context: ..
      dockerfile: backend/nestjs/Dockerfile
    command: ["node", "dist/src/main.js"]
    environment:
      PORT: 3030
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/web_admin?schema=public
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      SERVICE_NAME: backend-nestjs
      SERVICE_VERSION: dev
      DEPLOYMENT_ENV: local
      NODE_ENV: production
      LOG_DRIVER: pino
    ports:
      - "3030:3030"
    volumes:
      - backend-uploads:/app/backend/nestjs/uploads
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
      migrate:
        condition: service_completed_successfully
      seed:
        condition: service_completed_successfully

  frontend:
    build:
      context: ..
      dockerfile: frontend/react18/Dockerfile
      args:
        VITE_APP_BASE: /
        VITE_APP_API_BASE: /api
    logging: *default-logging
    ports:
      - "8080:80"
    depends_on:
      backend:
        condition: service_started

volumes:
  postgres-data:
  redis-data:
  backend-uploads:
